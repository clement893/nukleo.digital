<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1" />
    <title>Nukleo Digital</title>
    
    <!-- DNS prefetch and preconnect for faster loading -->
    <link rel="dns-prefetch" href="https://fonts.googleapis.com" />
    <link rel="dns-prefetch" href="https://fonts.gstatic.com" />
    <link rel="dns-prefetch" href="https://api.manus.im" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    
    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#7c3aed" />
    
    <!-- Preload critical fonts for better performance -->
    <link rel="preload" href="/fonts/AktivGrotesk-Regular.woff2" as="font" type="font/woff2" crossorigin />
    <link rel="preload" href="/fonts/AktivGrotesk-Medium.woff2" as="font" type="font/woff2" crossorigin />
    <link rel="preload" href="/fonts/AktivGrotesk-Bold.woff2" as="font" type="font/woff2" crossorigin />
    
    <!-- Preload LCP image (LEO avatar) -->
    <link rel="preload" href="/leo-avatar.webp" as="image" type="image/webp" fetchpriority="high" />
    
    <!-- Performance hints -->
    <link rel="dns-prefetch" href="https://nukleodigital-production.up.railway.app" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5" />
  </head>

  <body>
    <!-- Dynamic Loader Container -->
    <div id="app-loader"></div>

    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
    
    <script>
      // Dynamic Loader System
      // Fetches the active loader from the database and injects it into the page
      (async function() {
        const isAdminPage = window.location.pathname.startsWith('/admin');
        const loaderContainer = document.getElementById('app-loader');
        
        // Skip loader on admin pages
        if (isAdminPage) {
          if (loaderContainer) {
            loaderContainer.style.display = 'none';
          }
          return;
        }
        
        try {
          // Fetch active loader from API
          const response = await fetch('/api/loader/active');
          const data = await response.json();
          
          if (!data || !data.code) {
            console.warn('No active loader found');
            if (loaderContainer) {
              loaderContainer.style.display = 'none';
            }
            return;
          }
          
          // Inject loader code into the page
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = data.code;
          
          // Extract and inject CSS
          const styleTag = tempDiv.querySelector('style');
          if (styleTag) {
            document.head.appendChild(styleTag);
          }
          
          // Extract and inject HTML (everything except style tags)
          const htmlContent = Array.from(tempDiv.childNodes)
            .filter(node => node.nodeName !== 'STYLE')
            .map(node => node.outerHTML || node.textContent)
            .join('');
          
          if (loaderContainer) {
            loaderContainer.innerHTML = htmlContent;
            
            // Execute any inline scripts
            const scripts = loaderContainer.querySelectorAll('script');
            scripts.forEach(oldScript => {
              const newScript = document.createElement('script');
              newScript.textContent = oldScript.textContent;
              oldScript.parentNode.replaceChild(newScript, oldScript);
            });
          }
          
          // Hide loader when app is ready (no artificial delay)
          window.addEventListener('load', () => {
            if (loaderContainer) {
              loaderContainer.classList.add('loader-fade-out');
              setTimeout(() => {
                loaderContainer.style.display = 'none';
              }, 500); // Just the fade-out animation time
            }
          });
          
        } catch (error) {
          console.error('Failed to load dynamic loader:', error);
          // Hide loader container on error
          if (loaderContainer) {
            loaderContainer.style.display = 'none';
          }
        }
      })();
    </script>
  </body>
</html>
